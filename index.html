<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o H√≠drica Financeira - Base Naval & Lespan</title>
    <!-- Bibliotecas: Bootstrap 5 e Chart.js -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --navy-primary: #0a2342;
            --navy-secondary: #2ca58d;
            --money-color: #198754; /* Verde para dinheiro */
            --lespan-color: #e56b6f;
            --bg-color: #f0f2f5;
        }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { background-color: white; border-bottom: 1px solid #eee; font-weight: 700; color: var(--navy-primary); }
        
        .nav-pills .nav-link.active { background-color: var(--navy-primary); }
        .nav-pills .nav-link { color: var(--navy-primary); font-weight: 600; margin-right: 10px; }
        
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--navy-primary); }
        .kpi-label { font-size: 0.85rem; color: #6c757d; text-transform: uppercase; letter-spacing: 1px; }
        
        .table-sm th, .table-sm td { vertical-align: middle; text-align: center; }
        .trend-up { color: #dc3545; font-weight: bold; }
        .trend-down { color: #198754; font-weight: bold; }
        
        .money-text { color: var(--money-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container py-4">
    
    <!-- Cabe√ßalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold" style="color: var(--navy-primary);"><i class="fa-solid fa-faucet-drip me-2"></i>Gest√£o H√≠drica & Financeira</h2>
            <p class="text-muted mb-0">Monitoramento Integrado: Volume (m¬≥) e Custo (R$)</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <label class="fw-bold text-muted me-2">Visualizar Ano:</label>
            <select id="yearSelect" class="form-select fw-bold shadow-sm" style="width: 150px;" onchange="updateUI()">
                <option value="2025">2025</option>
                <option value="2024">2024</option>
            </select>
        </div>
    </div>

    <!-- KPIs Principais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-5 border-primary">
                <div class="kpi-label">Consumo Total (m¬≥)</div>
                <div class="kpi-value" id="kpiConsumoTotal">0</div>
                <small class="text-muted">Base Naval + Lespan</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-5 border-success">
                <div class="kpi-label">Custo Total (R$)</div>
                <div class="kpi-value money-text" id="kpiCustoTotal">R$ 0,00</div>
                <small class="text-muted">Soma das faturas</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-5 border-warning">
                <div class="kpi-label">Pre√ßo M√©dio (R$/m¬≥)</div>
                <div class="kpi-value text-warning" id="kpiPrecoMedio">R$ 0,00</div>
                <small class="text-muted">Efici√™ncia Financeira</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100 border-start border-5 border-danger">
                <div class="kpi-label">Maior Fatura do Ano</div>
                <div class="kpi-value text-danger" style="font-size: 1.5rem;" id="kpiMaiorFatura">R$ 0,00</div>
                <small class="text-muted" id="kpiMesMaiorFatura">-</small>
            </div>
        </div>
    </div>

    <!-- Navega√ß√£o por Abas -->
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-dashboard-tab" data-bs-toggle="pill" data-bs-target="#pills-dashboard" type="button">üìä Gr√°ficos & Finan√ßas</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-2025-tab" data-bs-toggle="pill" data-bs-target="#pills-2025" type="button">üìÖ Detalhado 2025</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-2024-tab" data-bs-toggle="pill" data-bs-target="#pills-2024" type="button">üìÖ Detalhado 2024</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-compare-tab" data-bs-toggle="pill" data-bs-target="#pills-compare" type="button">‚öñÔ∏è Comparativo Anual</button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <!-- ABA 1: DASHBOARD GR√ÅFICO & FINANCEIRO -->
        <div class="tab-pane fade show active" id="pills-dashboard">
            
            <!-- GR√ÅFICO PRINCIPAL: PARALELO m3 vs R$ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-success"><i class="fa-solid fa-sack-dollar me-2"></i>An√°lise Financeira: Consumo Real vs Custo</span>
                        </div>
                        <div class="card-body">
                            <canvas id="financeChart" height="100"></canvas>
                            <div class="text-center mt-2 text-muted small">
                                * Barras Azuis = Volume de √Ågua (m¬≥) | Linha Verde = Valor Pago (R$)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">Volume Consumido (Base Naval vs Lespan)</div>
                        <div class="card-body">
                            <canvas id="mainChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">Status das Leituras</div>
                        <div class="card-body">
                             <div class="alert alert-info">
                                <strong><i class="fa-solid fa-info-circle"></i> Nota:</strong> 
                                A correla√ß√£o entre m¬≥ e R$ ajuda a identificar se houve aumento de tarifa ou desperd√≠cio. 
                                Se a linha verde subir enquanto as barras azuis descem, o custo unit√°rio aumentou.
                             </div>
                            <ul class="list-group list-group-flush" id="statusList">
                                <!-- Preenchido via JS -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA 2: DETALHADO 2025 -->
        <div class="tab-pane fade" id="pills-2025">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Faturas de 2025</span>
                    <span class="badge bg-primary">Ano Corrente</span>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-hover table-striped table-sm align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>M√™s</th>
                                <th>Base Naval (m¬≥)</th>
                                <th>Lespan (m¬≥)</th>
                                <th class="bg-primary border-start">Total (m¬≥)</th>
                                <th class="bg-success border-start">Custo Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody2025"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA 3: DETALHADO 2024 -->
        <div class="tab-pane fade" id="pills-2024">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Faturas de 2024</span>
                    <span class="badge bg-secondary">Hist√≥rico</span>
                </div>
                <div class="card-body table-responsive">
                    <table class="table table-hover table-striped table-sm align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>M√™s</th>
                                <th>Base Naval (m¬≥)</th>
                                <th>Lespan (m¬≥)</th>
                                <th class="bg-primary border-start">Total (m¬≥)</th>
                                <th class="bg-success border-start">Custo Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody2024"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA 4: COMPARATIVO -->
        <div class="tab-pane fade" id="pills-compare">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">Comparativo Volume (m¬≥)</div>
                        <div class="card-body">
                            <canvas id="compareChartVol" height="150"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">Comparativo Financeiro (R$)</div>
                        <div class="card-body">
                            <canvas id="compareChartFin" height="150"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">Tabela de Varia√ß√£o (2025 vs 2024)</div>
                        <div class="card-body table-responsive">
                            <table class="table table-bordered text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>M√™s</th>
                                        <th>Total m¬≥ 2024</th>
                                        <th>Total m¬≥ 2025</th>
                                        <th>Var. Volume</th>
                                        <th>Total R$ 2024</th>
                                        <th>Total R$ 2025</th>
                                        <th>Var. Custo</th>
                                    </tr>
                                </thead>
                                <tbody id="compareTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // DADOS ESTRUTURADOS - VOLUME (m3)
    const dbVol = {
        months: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
        
        // Base Naval (Soma H1+H2)
        baseNaval: {
            2024: [39599, 41471, 38758, 40874, 39625, 33576, 32257, 29161, 30129, 37508, 24498, 28735],
            2025: [29523, 31152, 31525, 35663, 33971, 28708, 31069, 31039, 30794, 37508, null, null]
        },
        // Lespan
        lespan: {
            2024: [171, 81, 124, 111, 217, 54, 111, 287, 153, 153, 166, 254],
            2025: [103, 133, 324, 352, 417, 555, 763, 567, 706, 153, null, null]
        }
    };

    // DADOS ESTRUTURADOS - CUSTOS (R$) - Soma de todas as faturas do m√™s
    const dbFin = {
        2024: [
            1309686.00, 1286805.95, 1306085.00, 1392186.64, 1263393.00, 
            1120495.00, 1075082.00, 981056.00, 1004037.00, 1254901.20, 
            821544.00, 1084810.00
        ],
        2025: [
            1113089.00, 1175472.00, 1196680.00, 1353333.00, 1292153.00, 
            1080406.00, 1196040.00, 874621.00, 1355213.00, 1225487.00 /*Estimado Out*/, 0, 0
        ]
    };

    // Vari√°veis dos Gr√°ficos
    let mainChart, financeChart, cmpVolChart, cmpFinChart;

    function updateUI() {
        const year = document.getElementById('yearSelect').value;
        updateKPIs(year);
        renderMainChart(year);
        renderFinanceChart(year);
        renderStatusList(year);
    }

    function updateKPIs(year) {
        const volBN = dbVol.baseNaval[year];
        const volLP = dbVol.lespan[year];
        const custo = dbFin[year];

        let totalVol = 0;
        let totalCusto = 0;
        let maxCusto = 0;
        let maxCustoIdx = -1;
        let countMeses = 0;

        for(let i=0; i<12; i++) {
            if(volBN[i] !== null) {
                totalVol += volBN[i] + volLP[i];
                if(custo[i] > 0) {
                    totalCusto += custo[i];
                    countMeses++;
                    if(custo[i] > maxCusto) {
                        maxCusto = custo[i];
                        maxCustoIdx = i;
                    }
                }
            }
        }

        const precoMedio = totalVol > 0 ? (totalCusto / totalVol) : 0;

        document.getElementById('kpiConsumoTotal').innerText = totalVol.toLocaleString('pt-BR');
        document.getElementById('kpiCustoTotal').innerText = totalCusto.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        document.getElementById('kpiPrecoMedio').innerText = precoMedio.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) + " / m¬≥";
        
        document.getElementById('kpiMaiorFatura').innerText = maxCusto.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        document.getElementById('kpiMesMaiorFatura').innerText = maxCustoIdx >= 0 ? dbVol.months[maxCustoIdx] : '-';
    }

    function renderTable(year, tableId) {
        const tbody = document.getElementById(tableId);
        tbody.innerHTML = '';
        
        const bn = dbVol.baseNaval[year];
        const lp = dbVol.lespan[year];
        const cs = dbFin[year];

        dbVol.months.forEach((m, i) => {
            if(bn[i] === null && year === '2025') return;

            const vBn = bn[i] || 0;
            const vLp = lp[i] || 0;
            const total = vBn + vLp;
            const custo = cs[i] || 0;

            const row = `
                <tr>
                    <td class="fw-bold">${m}</td>
                    <td>${vBn.toLocaleString()}</td>
                    <td>${vLp.toLocaleString()}</td>
                    <td class="fw-bold text-primary bg-light border-start">${total.toLocaleString()}</td>
                    <td class="fw-bold text-success bg-light border-start">${custo > 0 ? custo.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : '-'}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function renderComparativo() {
        const tbody = document.getElementById('compareTableBody');
        tbody.innerHTML = '';

        dbVol.months.forEach((m, i) => {
            // Volume
            const vol24 = (dbVol.baseNaval[2024][i] || 0) + (dbVol.lespan[2024][i] || 0);
            const bn25 = dbVol.baseNaval[2025][i];
            
            // Financeiro
            const fin24 = dbFin[2024][i] || 0;
            const fin25 = dbFin[2025][i] || 0;

            if(bn25 === null) {
                tbody.innerHTML += `<tr><td class="fw-bold">${m}</td><td>${vol24.toLocaleString()}</td><td>-</td><td>-</td><td>${fin24.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td><td>-</td><td>-</td></tr>`;
                return;
            }

            const vol25 = bn25 + (dbVol.lespan[2025][i] || 0);
            
            // Varia√ß√£o Vol
            const varVol = ((vol25 - vol24) / vol24) * 100;
            const colorVol = varVol > 0 ? 'trend-up' : 'trend-down';
            
            // Varia√ß√£o Fin
            let varFinHtml = '-';
            if(fin25 > 0) {
                const varFin = ((fin25 - fin24) / fin24) * 100;
                const colorFin = varFin > 0 ? 'trend-up' : 'trend-down';
                varFinHtml = `<span class="${colorFin}">${varFin > 0 ? '+' : ''}${varFin.toFixed(1)}%</span>`;
            }

            const row = `
                <tr>
                    <td class="fw-bold">${m}</td>
                    <td>${vol24.toLocaleString()}</td>
                    <td>${vol25.toLocaleString()}</td>
                    <td class="${colorVol}">${varVol > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(varVol).toFixed(1)}%</td>
                    <td>${fin24.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</td>
                    <td>${fin25 > 0 ? fin25.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}) : '-'}</td>
                    <td>${varFinHtml}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // GR√ÅFICO DE BARRAS EMPILHADAS (VOLUME)
    function renderMainChart(year) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(mainChart) mainChart.destroy();

        const bn = dbVol.baseNaval[year];
        const lp = dbVol.lespan[year];

        mainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dbVol.months,
                datasets: [
                    { label: 'Base Naval (Total)', data: bn, backgroundColor: '#0a2342' },
                    { label: 'Lespan Clube', data: lp, backgroundColor: '#e56b6f' }
                ]
            },
            options: { 
                responsive: true, 
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } 
            }
        });
    }

    // GR√ÅFICO COMBO: FINANCEIRO (LINHA) vs VOLUME (BARRA)
    function renderFinanceChart(year) {
        const ctx = document.getElementById('financeChart').getContext('2d');
        if(financeChart) financeChart.destroy();

        // Preparar dados totais de volume
        const totalVol = dbVol.baseNaval[year].map((v, i) => (v!==null) ? v + dbVol.lespan[year][i] : null);
        const totalFin = dbFin[year].map(v => v > 0 ? v : null);

        financeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dbVol.months,
                datasets: [
                    {
                        label: 'Valor da Fatura (R$)',
                        data: totalFin,
                        type: 'line',
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        borderWidth: 3,
                        yAxisID: 'y1',
                        tension: 0.3,
                        pointRadius: 4,
                        fill: true
                    },
                    {
                        label: 'Consumo Total (m¬≥)',
                        data: totalVol,
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        yAxisID: 'y',
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Volume (m¬≥)' },
                        grid: { drawOnChartArea: false }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Custo (R$)' },
                        grid: { drawOnChartArea: true } // Grade apenas para o dinheiro
                    }
                }
            }
        });
    }

    // GR√ÅFICOS COMPARATIVOS (ABA 4)
    function renderCompareCharts() {
        // Comparativo Volume
        const ctx1 = document.getElementById('compareChartVol').getContext('2d');
        if(cmpVolChart) cmpVolChart.destroy();

        const vol24 = dbVol.baseNaval[2024].map((v, i) => v + dbVol.lespan[2024][i]);
        const vol25 = dbVol.baseNaval[2025].map((v, i) => (v!==null) ? v + dbVol.lespan[2025][i] : null);

        cmpVolChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: dbVol.months,
                datasets: [
                    { label: '2024', data: vol24, borderColor: '#adb5bd', borderDash: [5,5], borderWidth: 2 },
                    { label: '2025', data: vol25, borderColor: '#0a2342', borderWidth: 3, backgroundColor: 'rgba(10,35,66,0.1)', fill: true }
                ]
            },
            options: { responsive: true }
        });

        // Comparativo Financeiro
        const ctx2 = document.getElementById('compareChartFin').getContext('2d');
        if(cmpFinChart) cmpFinChart.destroy();

        cmpFinChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: dbVol.months,
                datasets: [
                    { label: '2024 (R$)', data: dbFin[2024], backgroundColor: '#adb5bd' },
                    { label: '2025 (R$)', data: dbFin[2025], backgroundColor: '#198754' }
                ]
            },
            options: { responsive: true }
        });
    }

    function renderStatusList(year) {
        const list = document.getElementById('statusList');
        const lastMonthIdx = dbVol.baseNaval[2025].filter(x => x !== null).length;
        const statusText = year === '2025' ? `Dados at√© ${dbVol.months[lastMonthIdx-1]}` : 'Dados Completos';
        
        list.innerHTML = `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Per√≠odo
                <span class="fw-bold text-primary">${statusText}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Matr√≠culas
                <span class="badge bg-secondary">3 Ativas</span>
            </li>
        `;
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        updateUI();
        renderTable('2024', 'tableBody2024');
        renderTable('2025', 'tableBody2025');
        renderComparativo();
        renderCompareCharts();
    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
